#!/usr/bin/env ruby
#
# X10 sinatra server
#
require 'rubygems'
require 'sinatra'
require 'yaml'
require 'x10_sinatra'

config = YAML.load_file("#{ENV['HOME']}/.x10_sinatra.yaml")    
#puts  File.dirname(__FILE__)
set :public, File.dirname(__FILE__)
#puts settings.public

get '/css/style.css' do
end

get '/' do
    "<!DOCTYPE html PUBLIC '-//W3C//DTD HTML 4.01//EN'>" +
    "<html>" +
    "<head>" +
      "<title>X10 Controller</title>" +
        "<link rel='stylesheet' href='style.css'>" +
    "</head>" +
    "<body>" +
    "<form method='POST' action='/x10'>" +
        "<input type='radio' name='device_num' value='1' checked />1    #{config['1']}<br />" +
        "<input type='radio' name='device_num' value='2' />2    #{config['2']}<br />" +
        "<input type='radio' name='device_num' value='3' />3    #{config['3']}<br />" +
        "<input type='radio' name='device_num' value='4' />4    #{config['4']}<br />" +
        "<input type='radio' name='device_num' value='5' />5    #{config['5']}<br />" +
        "<input type='radio' name='device_num' value='6' />6    #{config['6']}<br />" +
        "<input type='radio' name='device_num' value='7' />7    #{config['7']}<br />" +
        "<input type='radio' name='device_num' value='8' />8    #{config['8']}<br />" +
        "<select name='device_letter'>" +
            "<option value='a'>A</option>" +
            "<option value='b'>B</option>" +
            "<option value='c'>C</option>" +
            "<option value='d'>D</option>" +
            "<option value='e'>E</option>" +
            "<option value='f'>F</option>" +
        "</select><br />" +
        "<input type='submit' name='command' value='on' />" +
        "<input type='submit' name='command' value='off' />" +
        "<input type='submit' name='command' value='step up' />" +
        "<input type='submit' name='command' value='step down' />" +
    "</form>" +
    "</body>" +
    "</html>"
end

post '/x10' do
    device = params['device_letter'] + params['device_num']
    x10sinatra = X10Sinatra.new(device)

    case params['command']
    when "on"
        x10sinatra.on
    when "off"
        x10sinatra.off
    when "step up"
        x10sinatra.step_up
    when "step down"
        x10sinatra.step_down
    end
    redirect ("/")
end

